<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="com.position.positionSquareService.mapper.ClientMapper">
	<resultMap id="clientMap" type="map">
		<result property="id" column="ID" />
		<result property="name" column="CLIENT_NAME" />
		<result property="pan" column="PAN" />
	</resultMap>
	<resultMap id="projectMap" type="map">
		<result property="id" column="ID" />
		<result property="name" column="NAME" />
		<result property="description" column="DESCRIPTION" />
		<result property="state" column="CURRENT_STATE" />
		<result property="projectStart"
			column="ESTIMATED_PROJECT_START" />
		<result property="projectEnd" column="ESTIMATED_PROJECT_END" />
		<result property="createdTime" column="CREATED_TS" />
	</resultMap>

	<resultMap id="taskMap" type="map">
		<result property="id" column="TASK_ID" />
		<result property="name" column="TASK_NAME" />
		<result property="description" column="TASK_DESCRIPTION" />
		<result property="duration" column="TASK_DURATION_HRS" />
		<result property="start" column="TASK_START" />
		<result property="end" column="TASK_END" />
		<result property="status" column="TASK_STATUS" />
		<result property="createdTime" column="CREATED_TS" />
		<result property="progress" column="PROGRESS" />
		 <collection property="dependencies"  ofType="java.lang.Integer"  javaType="list">
			<result column="DEPENDENT_ID" javaType="java.lang.Integer" />
		</collection>
		 <collection property="projectDependency"  resultMap="view" javaType="list" />
	</resultMap>
	<resultMap type="map" id="view"> 
	<result property="projectId" column="ID" />
			<result property="projectName" column="NAME" />
			<result property="taskName" column="LINKED_TASK_NAME" />
	</resultMap>
	
	<select id="getTasksDependency" resultType="int">
		SELECT TASK_DEPENDENT_ID from TASK_DEPENDENCY t
		<where>
			t.TASK_CURRENT_ID=#{ID} 
		</where>
	</select>

	<select id="getClients" resultMap="clientMap">
		SELECT * FROM CLIENT;
	</select>

	<select id="getProjects" resultMap="projectMap">
		SELECT
		ID,NAME,DESCRIPTION,CURRENT_STATE,ESTIMATED_PROJECT_START,ESTIMATED_PROJECT_END,
		CREATED_TS
		FROM PROJECT p
		<where>
			p.CLIENT_ID=#{clientId} 
		</where>
		ORDER BY CREATED_TS;
	</select>

	<select id="getTasks" resultMap="taskMap">
		SELECT t.ID as TASK_ID,t.TASK_DESCRIPTION,t.TASK_NAME,t.TASK_DURATION_HRS,t.TASK_START,t.TASK_END,t.TASK_STATUS,t.CREATED_TS,t.PROGRESS,
		td.TASK_DEPENDENT_ID as DEPENDENT_ID, tt.TASK_NAME  AS LINKED_TASK_NAME , tt.ID as ID ,p.NAME as NAME 
		FROM TASKS t 
		LEFT JOIN TASK_DEPENDENCY td ON t.ID = td.TASK_CURRENT_ID 
		LEFT JOIN TASKS tt ON tt.ID = td.TASK_DEPENDENT_ID 
		LEFT JOIN PROJECT p ON tt.PROJECT_ID = p.ID 
		<where>
			t.PROJECT_ID=#{projectId} 
		</where>
		ORDER BY CREATED_TS;
	</select>

</mapper>
